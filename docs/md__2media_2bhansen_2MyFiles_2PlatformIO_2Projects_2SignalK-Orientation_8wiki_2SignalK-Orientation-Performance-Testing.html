<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SignalK-Orientation: SignalK-Orientation-Performance-Testing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SignalK-Orientation<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">Orientation output in Signal K format for ESP32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">SignalK-Orientation-Performance-Testing</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here are test results for <b>Max update rate</b> and <b>Latency</b>, from tests on 2021 Feb 03-04.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Setup</h2>
<ul>
<li>Lolin <em>d1_mini</em> (ESP8266) board</li>
<li>firmware was the <em>SignalK-Orientation</em> library current release. <code>main.cpp</code> was configured to provide Signal K updates for the <b>standard sensors</b> (<em>freemem, systemHz, IP address, WiFi signal strength, uptime</em>), plus <b>headingCompass</b>, <b>headingMagnetic</b>, and <b><a class="el" href="structAttitude.html">Attitude</a></b>. The two heading parameters had a reporting interval of 25 ms (40 Hz); attitude was reporting every 500 ms; the rest of the parameters every 1000 ms.</li>
<li>before compiling the firmware, the file <code>net/ws_client.cpp</code> in the SensESP library was edited to increase the maximum reporting rate, which is only 10 Hz. Line 74 was changed to <code>app.onRepeat(1, [this]() { this-&gt;send_delta(); });</code> - it originally had <b>100* instead of **1</b> ms as the interval between checking for and sending Signal K updates.</li>
<li>also before compiling the firmware, <code><a class="el" href="orientation__sensor_8cpp.html" title="Orientation sensor interface to SensESP.">orientation_sensor.cpp</a></code> was edited to read the digital state of GPIO pin 5 and report that as the heading, instead of the actual compass heading.</li>
<li>the <em>d1_mini</em> connected to the local network using WiFi via a Netgear R6400 router.</li>
<li>a signal generator was connected to the <em>d1_mini</em> GPIO pin 5, and set to output a square wave</li>
<li>a Raspberry Pi 2 Model B Rev 1.1 was attached to the local network via ethernet cable. The Pi was running Signal K server v1.37.6.</li>
<li>a CANbus board (Waveshare's <em>2-Channel Isolated CAN Expansion HAT for Raspberry Pi</em>) connected to the Pi and provided NMEA 2000 output.</li>
</ul>
<h2><a class="anchor" id="autotoc_md22"></a>
Method</h2>
<p>By monitoring the NMEA 2000 bus simultaneously with the signal generator using an oscilloscope, the NMEA 2000 packet update rate as well as the latency between the signal change and the corresponding output on the bus could be determined.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Results</h2>
<p>The following example scope capture illustrates the measurements made: <img src="./images/2021-02-03_UpdateRateAndLatency.png?raw=true" alt="Scope capture" title="Update Rate and Latency measurements" class="inline"/> The yellow trace shows the NMEA 2000 (CAN bus) traffic. There was only the Signal K server on the bus, so it is the source of all the packets. A <b>packet is observed every approximately 25 ms</b>, which is expected given the 40 Hz reporting rate for the Magnetic Heading.</p>
<p>The six visible NMEA 2000 packets are decoded in the table at the top of the scope display. The 2nd and 3rd bytes in the <em>Data</em> column reflect the reported Magnetic Heading.</p>
<p>The green trace is from the signal generator input to the <em>d1_mini</em>. Observe how the data in the 5th NMEA packet (approx 40 ms after the low -&gt; high transition) changes from 0x00 0x00 to 0x10 0x27, indicating that the Signal K server has reported the changed heading (i.e. signal generator input) on the NMEA 2000 bus.</p>
<h3><a class="anchor" id="autotoc_md24"></a>
Latency</h3>
<p>Since the signal generator was asynchronous with respect to the timing of the <em>d1_mini</em> and the <em>Signal K server</em>, it was possible to determine the system latency by observing over an extended period the time lag between the signal transition and the appearance of the changed NMEA 2000 packet. The latency varied between about 29 ms to as long as 50 ms, which is consistent with:</p><ul>
<li><b>50 ms</b>: the signal changed just after an update from the <em>d1_mini</em>. It took 25 ms before the next update, and then about 25 ms for the <em>Signal K server</em> to process it and push it onto the bus</li>
<li><b>29 ms</b>: The signal changed just before an update from the <em>d1_mini</em>, which reported the new level. It took another approx 25 ms for <em>Signal K server</em> to process it and push it onto the bus.</li>
</ul>
<p>So one can conclude that the signal path through the router to the Pi, plus the time to process the data, plus the time to send it to the CAN bus hardware, was about 25 ms in this experiment. It is not known what proportion of this time is attributable to the WiFi router - one could perform an experiment where the <em>d1_mini</em> sends directly to the <em>rPi</em> acting as an Access Point to determine this.</p>
<p>An upper bound to the latency would then be the <em>d1_mini</em> reporting interval (25 ms), plus the transit time through the rest of the chain (25 ms), for a total of about 50 ms. If the reporting interval changes, the total latency will increase correspondingly.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Packet Update Rate</h2>
<p>The NMEA 2000 packets were consistently output at the rate sent by the <em>d1_mini</em>, i.e. 40 Hz. A small jitter of up to about 5 ms was observed, and attributed to other tasks that the <em>rPi</em> was performing. CPU load, using the <code>top</code> command was between 32% and 36% during the test.</p>
<p>The scope was set to capture any intervals between packets longer than 80 ms (recall that the expected interval was 25 ms), and over a duration of 5 minutes one such trigger event happened, with 92 ms between the NMEA 2000 bus packets. It is not known whether the additional delay was due to the WiFi router or the rPi.</p>
<p>Over a 30 hour period, the Signal K server continued to keep up with the incoming heading updates, with occasional dropouts lasting 40 ms to 120 ms occurring every few minutes on average.</p>
<p>It seems reasonable to conclude that the orientation sensor can be used to stream compass heading data to a NMEA 2000 bus at rates up to 40 Hz. Most commercial units seem to have a refresh rate of 10 Hz to 20 Hz.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Multiple Heading Sources</h2>
<p>The above test was modified to add an additional orientation sensor, consisting of an <em>ESP32-WROVER</em> board, sending updates to the Signal K server concurrently with the <em>d1_mini</em>. It is not a configuration that would likely be used on a vessel, but it was performed to see how the the server would cope with the additional traffic. With both sensors outputting updates at intervals of 25 ms, the NMEA 2000 bus showed 25 packets in 656 ms, or about 1 packet every 25 ms. So it seems that the <b>maximum update rate</b> that is <b>published to the NMEA 2000 bus</b>, using the hardware and software tested, <b>is about 40 Hz</b>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 18 2026 13:43:20 for SignalK-Orientation by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
